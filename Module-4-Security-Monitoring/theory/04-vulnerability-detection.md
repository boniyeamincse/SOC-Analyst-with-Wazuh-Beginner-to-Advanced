# Vulnerability Detection with Wazuh

## 🎯 Learning Objectives

By the end of this section, you will understand:
- How Wazuh vulnerability detection works
- Configuring vulnerability scans and assessments
- Integration with vulnerability databases
- Risk assessment and prioritization
- Compliance reporting for vulnerabilities
- Patch management integration

## 📋 Vulnerability Detection Overview

### What is Vulnerability Detection?
**Vulnerability Detection** is the process of identifying, assessing, and prioritizing security weaknesses in systems, applications, and configurations that could be exploited by attackers.

### Why It Matters in SOC Operations
```
┌─────────────────────────────────────────────────────────────┐
│            VULNERABILITY DETECTION VALUE                   │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ RISK        │  │ COMPLIANCE  │  │ THREAT      │          │
│  │ MANAGEMENT  │  │ REPORTING   │  │ INTELLIGENCE │          │
│  │             │  │             │  │             │          │
│  │ • Prioritize │  │ • PCI-DSS    │  │ • CVE       │          │
│  │   patches   │  │ • HIPAA      │  │   correlation│          │
│  │ • Resource   │  │ • ISO 27001  │  │ • Exploit    │          │
│  │   allocation│  │ • GDPR       │  │   intelligence│          │
│  │ • Risk      │  │             │  │ • Attack      │          │
│  │   assessment│  │             │  │   patterns   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ OPERATIONAL │  │ STRATEGIC   │  │ AUTOMATION  │          │
│  │ EFFICIENCY  │  │ PLANNING    │  │ CAPABILITIES│          │
│  │             │  │             │  │             │          │
│  │ • Automated  │  │ • Risk      │  │ • Continuous │          │
│  │   scanning  │  │   assessment│  │   monitoring │          │
│  │ • Alert      │  │ • Budget     │  │ • Patch      │          │
│  │   triage    │  │   planning  │  │   management │          │
│  │ • Report     │  │ • Resource   │  │ • Integration│          │
│  │   generation│  │   allocation│  │   workflows  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 🏗️ Wazuh Vulnerability Detection Architecture

### Vulnerability Detection Components

#### 1. Vulnerability Scanner
```yaml
# Wazuh vulnerability scanner configuration
vulnerability_detection:
  enabled: yes
  interval: 1h
  run_on_start: yes
  
  # Feed configuration
  feed:
    update_interval: 1h
    cti_url: https://cti.wazuh.com/api/v1/catalog
```

#### 2. Database Integration
```yaml
# Vulnerability database settings
vulnerability_detection:
  database:
    type: sqlite3
    path: /var/ossec/queue/vulnerabilities/cve.db
    
  # External feeds
  feeds:
    - name: canonical
      url: https://people.canonical.com/~ubuntu-security/cve/
    - name: redhat
      url: https://access.redhat.com/security/cve/
    - name: nvd
      url: https://nvd.nist.gov/feeds/json/cve/1.1/
```

#### 3. Assessment Engine
```yaml
# Vulnerability assessment rules
vulnerability_detection:
  assessment:
    # Risk scoring
    cvss_score:
      critical: 9.0
      high: 7.0
      medium: 4.0
      low: 0.1
      
    # Package filtering
    packages:
      include:
        - "openssh*"
        - "apache2*"
        - "mysql*"
      exclude:
        - "kernel*"
        - "linux*"
```

### Vulnerability Detection Process Flow

#### 1. Asset Discovery
```bash
# Collect system information
/var/ossec/bin/wazuh-control start

# Agent inventory collection
- OS version and architecture
- Installed packages and versions
- Running services and processes
- System configuration details
```

#### 2. Vulnerability Matching
```bash
# Compare against vulnerability database
- Match package versions against CVE database
- Check for known vulnerabilities
- Calculate CVSS scores
- Determine exploitability
```

#### 3. Risk Assessment
```bash
# Evaluate vulnerability impact
- CVSS base score analysis
- Environmental factors
- Threat intelligence correlation
- Business impact assessment
```

#### 4. Alert Generation
```bash
# Create vulnerability alerts
- Severity-based prioritization
- Compliance mapping
- Remediation recommendations
- Escalation workflows
```

## ⚙️ Vulnerability Detection Configuration

### Basic Configuration

#### Enable Vulnerability Detection
```xml
<!-- /var/ossec/etc/ossec.conf -->
<vulnerability_detection>
  <enabled>yes</enabled>
  <interval>1h</interval>
  <run_on_start>yes</run_on_start>
  <feed_update_interval>1h</feed_update_interval>
</vulnerability_detection>
```

#### Vulnerability Scanner Settings
```xml
<!-- Advanced vulnerability scanning -->
<vulnerability_detection>
  <!-- Scan settings -->
  <scan:
    <enabled>yes</enabled>
    <interval>1h</interval>
    <package_inventory>yes</package_inventory>
    <hotfix_check>yes</hotfix_check>
  />
  
  <!-- Database settings -->
  <database>
    <enabled>yes</enabled>
    <path>queue/vulnerabilities</path>
    <update_interval>1h</update_interval>
  </database>
</vulnerability_detection>
```

### Advanced Configuration Options

#### Custom Vulnerability Feeds
```xml
<!-- Custom vulnerability feeds -->
<vulnerability_detection>
  <feeds>
    <feed>
      <name>custom_feed</name>
      <url>https://your-custom-feed.com/vulnerabilities.json</url>
      <update_interval>4h</update_interval>
    </feed>
  </feeds>
</vulnerability_detection>
```

#### Package Filtering
```xml
<!-- Package-specific monitoring -->
<vulnerability_detection>
  <packages>
    <!-- Monitor specific packages -->
    <include>
      <package>openssh*</package>
      <package>apache*</package>
      <package>mysql*</package>
    </include>
    
    <!-- Exclude kernel packages -->
    <exclude>
      <package>kernel*</package>
      <package>linux-image*</package>
    </exclude>
  </packages>
</vulnerability_detection>
```

#### Risk-Based Alerting
```xml
<!-- Risk-based vulnerability alerting -->
<vulnerability_detection>
  <alerts>
    <!-- Alert thresholds -->
    <threshold>
      <level>critical</level>
      <cvss_score>9.0</cvss_score>
    </threshold>
    
    <threshold>
      <level>high</level>
      <cvss_score>7.0</cvss_score>
    </threshold>
    
    <!-- Suppress old vulnerabilities -->
    <suppress>
      <days>90</days>
      <cvss_score_below>4.0</cvss_score_below>
    </suppress>
  </alerts>
</vulnerability_detection>
```

## 🔍 Vulnerability Assessment and Analysis

### Understanding Vulnerability Data

#### Vulnerability Event Structure
```json
{
  "vulnerability": {
    "cve": "CVE-2021-44228",
    "title": "Apache Log4j2 Remote Code Execution",
    "severity": "Critical",
    "cvss_score": 10.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H",
    "published": "2021-12-10T00:00:00Z",
    "updated": "2021-12-15T00:00:00Z",
    "package": {
      "name": "log4j",
      "version": "2.14.1",
      "architecture": "x86_64"
    },
    "condition": "Package less than 2.15.0",
    "reference": "https://nvd.nist.gov/vuln/detail/CVE-2021-44228"
  }
}
```

#### CVSS Score Interpretation
```bash
# CVSS v3.1 Base Score Ranges
0.0 - 3.9: Low severity
4.0 - 6.9: Medium severity
7.0 - 8.9: High severity
9.0 - 10.0: Critical severity

# CVSS Vector Breakdown
CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
├── AV:N - Attack Vector: Network
├── AC:L - Attack Complexity: Low
├── PR:N - Privileges Required: None
├── UI:N - User Interaction: None
├── S:C - Scope: Changed
├── C:H - Confidentiality: High
├── I:H - Integrity: High
└── A:H - Availability: High
```

### Vulnerability Assessment Rules

#### Critical Vulnerability Detection
```xml
<!-- Alert on critical vulnerabilities -->
<rule id="23501" level="15">
  <if_sid>23500</if_sid>
  <field name="vulnerability.severity">Critical</field>
  <description>Vulnerability: Critical severity detected</description>
  <group>vulnerability-detector,critical</group>
</rule>
```

#### Package-Specific Alerts
```xml
<!-- Monitor specific high-risk packages -->
<rule id="23502" level="12">
  <if_sid>23500</if_sid>
  <field name="vulnerability.package.name">^openssh|^apache|^mysql</field>
  <description>Vulnerability: High-risk package affected</description>
  <group>vulnerability-detector,high-risk-package</group>
</rule>
```

#### Zero-Day Vulnerability Detection
```xml
<!-- Alert on recently published vulnerabilities -->
<rule id="23503" level="10">
  <if_sid>23500</if_sid>
  <field name="vulnerability.published">>1d</field>
  <description>Vulnerability: Recently published (potential zero-day)</description>
  <group>vulnerability-detector,recent</group>
</rule>
```

## 📊 Vulnerability Reporting and Analytics

### Vulnerability Dashboard Setup

#### Kibana Visualization for Vulnerabilities
```json
{
  "title": "Vulnerability Overview",
  "visState": {
    "title": "Vulnerability Trends",
    "type": "line",
    "params": {
      "type": "line",
      "grid": {
        "categoryLines": false
      },
      "seriesParams": [
        {
          "show": "true",
          "type": "line",
          "mode": "normal",
          "data": {
            "label": "Critical Vulnerabilities",
            "id": "1"
          }
        }
      ]
    }
  }
}
```

### Vulnerability Metrics and KPIs

#### Key Vulnerability Metrics
```bash
# Calculate vulnerability KPIs
TOTAL_VULNS=$(curl -s -u admin:admin -k "https://localhost:55000/vulnerability" | jq '.data.totalItems')
CRITICAL_VULNS=$(curl -s -u admin:admin -k "https://localhost:55000/vulnerability?severity=Critical" | jq '.data.totalItems')
AVG_CVSS_SCORE=$(curl -s -u admin:admin -k "https://localhost:55000/vulnerability" | jq '[.data.items[].cvss_score] | add / length')

echo "Total Vulnerabilities: $TOTAL_VULNS"
echo "Critical Vulnerabilities: $CRITICAL_VULNS"
echo "Average CVSS Score: $AVG_CVSS_SCORE"
```

#### Vulnerability Age Analysis
```bash
# Analyze vulnerability age distribution
OLD_VULNS=$(curl -s -u admin:admin -k "https://localhost:55000/vulnerability?published_before=90d" | jq '.data.totalItems')
RECENT_VULNS=$(curl -s -u admin:admin -k "https://localhost:55000/vulnerability?published_after=7d" | jq '.data.totalItems')

echo "Vulnerabilities older than 90 days: $OLD_VULNS"
echo "Vulnerabilities published in last 7 days: $RECENT_VULNS"
```

## 🔧 Integration with Patch Management

### Automated Patch Assessment
```bash
#!/bin/bash
# Automated patch assessment script

# Check for available patches
AVAILABLE_PATCHES=$(yum check-update | wc -l)

# Check vulnerability status
CRITICAL_VULNS=$(curl -s -u admin:admin -k "https://localhost:55000/vulnerability?severity=Critical" | jq '.data.totalItems')

# Generate patch report
echo "=== Patch Assessment Report ==="
echo "Date: $(date)"
echo "Available Patches: $AVAILABLE_PATCHES"
echo "Critical Vulnerabilities: $CRITICAL_VULNS"
echo
echo "Recommended Actions:"
if [ "$AVAILABLE_PATCHES" -gt 0 ]; then
  echo "- Schedule patch deployment"
fi
if [ "$CRITICAL_VULNS" -gt 0 ]; then
  echo "- Prioritize critical vulnerability remediation"
fi
```

### Patch Compliance Monitoring
```xml
<!-- Monitor patch compliance -->
<rule id="23504" level="8">
  <if_sid>23500</if_sid>
  <field name="vulnerability.status">unpatched</field>
  <description>Vulnerability: Unpatched vulnerability detected</description>
  <group>vulnerability-detector,compliance</group>
</rule>
```

## 📋 Compliance Reporting

### PCI-DSS Vulnerability Reporting
```bash
# Generate PCI-DSS vulnerability report
curl -X GET "https://localhost:55000/vulnerability" \
  -H "Authorization: Bearer $WAZUH_API_TOKEN" \
  -H "Content-Type: application/json" \
  --data '{
    "query": "vulnerability.severity:Critical OR vulnerability.severity:High",
    "select": ["vulnerability.cve", "vulnerability.title", "vulnerability.cvss_score", "agent.name"],
    "sort": "vulnerability.cvss_score:desc"
  }' > pci-dss-vulnerability-report.json
```

### HIPAA Security Assessment
```bash
# HIPAA vulnerability assessment
curl -X GET "https://localhost:55000/vulnerability" \
  -H "Authorization: Bearer $WAZUH_API_TOKEN" \
  --data '{
    "query": "agent.name:*medical* OR agent.groups:healthcare",
    "select": ["vulnerability.cve", "vulnerability.title", "agent.name"],
    "filters": {
      "vulnerability.cvss_score": {"gt": 7.0}
    }
  }' > hipaa-vulnerability-assessment.json
```

## 🚨 Vulnerability Response Workflows

### Automated Response Actions
```xml
<!-- Active response for critical vulnerabilities -->
<active-response>
  <command>vulnerability-isolate</command>
  <location>local</location>
  <rules_id>23501</rules_id>
  <timeout>3600</timeout>
</active-response>
```

### Vulnerability Remediation Workflow
```bash
# Step-by-step remediation process
1. Identify affected systems
2. Assess vulnerability impact
3. Check for available patches
4. Test patch in staging environment
5. Schedule production deployment
6. Monitor post-patch system stability
7. Update vulnerability status
8. Generate remediation report
```

## 🔧 Troubleshooting Vulnerability Detection

### Common Issues and Solutions

#### Issue 1: Missing Vulnerability Data
```bash
# Check vulnerability feed updates
curl -s -u admin:admin -k "https://localhost:55000/vulnerability/feed" | jq '.last_update'

# Force feed update
/var/ossec/bin/wazuh-control restart

# Check agent connectivity
/var/ossec/bin/agent_control -i
```

#### Issue 2: False Positive Alerts
```bash
# Exclude non-applicable vulnerabilities
<vulnerability_detection>
  <exclude>
    <cve>CVE-2021-12345</cve>
    <package>custom-package</package>
  </exclude>
</vulnerability_detection>

# Adjust CVSS thresholds
<vulnerability_detection>
  <threshold>
    <cvss_score>8.0</cvss_score> <!-- Only alert above 8.0 -->
  </threshold>
</vulnerability_detection>
```

#### Issue 3: Performance Issues
```bash
# Optimize scan intervals
<vulnerability_detection>
  <interval>4h</interval> <!-- Reduce frequency -->
  <feed_update_interval>6h</feed_update_interval>
</vulnerability_detection>

# Limit monitored packages
<vulnerability_detection>
  <packages>
    <include>
      <package>critical-apps*</package>
    </include>
  </packages>
</vulnerability_detection>
```

#### Issue 4: Database Issues
```bash
# Check database status
ls -la /var/ossec/queue/vulnerabilities/

# Rebuild vulnerability database
rm -f /var/ossec/queue/vulnerabilities/cve.db
/var/ossec/bin/wazuh-control restart
```

## 🎯 Best Practices for Vulnerability Management

### 1. Assessment and Planning
- **Risk-Based Prioritization**: Focus on high-impact vulnerabilities first
- **Environment Assessment**: Understand your system's attack surface
- **Resource Planning**: Allocate appropriate time and resources
- **Stakeholder Communication**: Keep teams informed of vulnerability status

### 2. Detection and Monitoring
- **Continuous Scanning**: Regular automated vulnerability assessments
- **Feed Updates**: Keep vulnerability databases current
- **Alert Tuning**: Configure appropriate alert thresholds
- **False Positive Management**: Regularly review and tune detection rules

### 3. Remediation and Response
- **Patch Management**: Implement systematic patch deployment processes
- **Testing Procedures**: Test patches in staging environments first
- **Rollback Planning**: Prepare for patch deployment failures
- **Documentation**: Maintain detailed remediation records

### 4. Reporting and Compliance
- **Regular Reporting**: Generate vulnerability reports for stakeholders
- **Compliance Monitoring**: Track compliance with regulatory requirements
- **Trend Analysis**: Monitor vulnerability trends over time
- **Executive Communication**: Provide clear risk assessments to leadership

## 📚 Self-Assessment Questions

1. How does Wazuh vulnerability detection work?
2. What are the key components of vulnerability assessment?
3. How can you configure vulnerability scanning in Wazuh?
4. What are the different ways to prioritize vulnerabilities?
5. How can vulnerability detection integrate with compliance requirements?

## 🔗 Next Steps

Now that you understand vulnerability detection, let's explore rootkit detection capabilities in Wazuh.

**[← Previous: File Integrity Monitoring](./03-file-integrity-monitoring.md)** | **[Next: Rootkit Detection](./05-rootkit-detection.md)**